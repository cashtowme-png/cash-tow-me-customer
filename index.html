<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cash Tow Me</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.json">

  <style>
    body { font-family: -apple-system, sans-serif; background:#f0f2f5; padding:20px; text-align:center; color: #333; }
    .card { background:white; padding:20px; border-radius:15px; margin:10px auto; max-width:400px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
    h1 { color: #d9534f; margin-top: 0; }
    .btn-main { background:#d9534f; color:white; padding:18px; font-size:18px; border:none; border-radius:12px; width:100%; font-weight:bold; cursor:pointer; }
    .driver-card { background: white; border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 400px; text-align: left; border-left: 5px solid #5cb85c; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .offline { border-left-color: #ccc; opacity: 0.6; }
    .call-btn { background:#5cb85c; color:white; padding:10px 20px; border-radius:8px; text-decoration:none; display:inline-block; font-weight:bold; margin-top:10px; }
    #status-msg { font-size: 14px; margin-top: 10px; color: #666; }
  </style>
</head>

<body>

  <div class="card">
    <h1>üöõ Cash Tow Me</h1>
    <p>Find local help fast. Pay your driver directly.</p>
    
    <button class="btn-main" onclick="requestTow()">üìç SEND MY LOCATION</button>
    <p id="status-msg">Click to send coordinates to dispatch</p>
  </div>

  <hr style="border:0; border-top:1px solid #ccc; margin:30px 0;">

  <h2>Available Drivers</h2>
  <div id="driver-list">
    </div>

  <script>
    // 1. GPS FUNCTION FOR CUSTOMERS
    function requestTow() {
      const status = document.getElementById("status-msg");
      const dispatchPhone = "2143098955";

      if (navigator.geolocation) {
        status.innerText = "Locating you...";
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const mapLink = `https://maps.apple.com/?q=${lat},${lon}`;
          
          status.innerText = "Location found! Opening messages...";
          
          // Pre-fills a text to dispatch
          const smsBody = encodeURIComponent(`I need a tow! My location: ${mapLink}`);
          window.location.href = `sms:${dispatchPhone}?&body=${smsBody}`;
        }, () => {
          status.innerText = "Please enable GPS in settings.";
        });
      }
    }

    // 2. DYNAMIC DRIVER LIST
    function displayDrivers() {
      const listContainer = document.getElementById("driver-list");
      // This pulls the same drivers that your Driver App saves
      const drivers = JSON.parse(localStorage.getItem("drivers") || "[]");

      if (drivers.length === 0) {
        listContainer.innerHTML = "<p>Searching for active drivers...</p>";
        return;
      }

      listContainer.innerHTML = "";
      drivers.forEach(d => {
        if (d.approved) {
          const div = document.createElement("div");
          div.className = `driver-card ${d.status === 'OFF' ? 'offline' : ''}`;
          
          div.innerHTML = `
            <h3>üöõ ${d.name} ‚Äì ${d.truck}</h3>
            <p>üìç <strong>City:</strong> ${d.city}</p>
            <p><strong>Status:</strong> ${d.status === 'ON' ? '‚úÖ Available' : '‚ùå Busy/Offline'}</p>
            ${d.status === 'ON' ? `<a href="tel:2143098955" class="call-btn">Call Driver</a>` : ''}
          `;
          listContainer.appendChild(div);
        }
      });
    }

    // Run on load
    displayDrivers();

    // 3. SERVICE WORKER
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
